services:
  # Development environment with hot-reload support
  dev:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/dist
    working_dir: /workspace
    environment:
      - NODE_ENV=development
    command: npm run build:watch
    stdin_open: true
    tty: true

  # Testing environment (Node.js 20 + Python 2)
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=test
    command: npm run test:unit

  # Mockup testing environment (Node.js 16 + Python 2 for screeps-server-mockup)
  mockup:
    build:
      context: .
      dockerfile: Dockerfile.mockup
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=test
    command: npm run test:mockup

  # Build environment (Node.js 20 for fast builds)
  build:
    build:
      context: .
      dockerfile: Dockerfile.build
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    environment:
      - NODE_ENV=production
    command: npm run build

  # Linting service
  lint:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    command: npm run lint

  # Formatting check service
  format:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - .:/workspace
      - /workspace/node_modules
    working_dir: /workspace
    command: npm run format:check

  # Screeps private server (Node.js 16 + Python 2 for native modules)
  screeps-server:
    build:
      context: .
      dockerfile: Dockerfile.screeps-server
    ports:
      - "21025:21025"
    volumes:
      - ./server-data:/screeps
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  # Screeps agent service
  screeps-agent:
    build:
      context: ./packages/screeps-agent
      dockerfile: Dockerfile
    volumes:
      - ./packages/screeps-agent:/app
      - /app/node_modules
      - /app/dist
    working_dir: /app
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - AGENT_NAME=${AGENT_NAME:-screeps-agent}
      - AGENT_VERSION=${AGENT_VERSION:-0.1.0}
      - SCREEPS_TOKEN=${SCREEPS_TOKEN}
      - SCREEPS_EMAIL=${SCREEPS_EMAIL}
      - SCREEPS_PASSWORD=${SCREEPS_PASSWORD}
      - SCREEPS_HOST=${SCREEPS_HOST:-screeps.com}
      - SCREEPS_PORT=${SCREEPS_PORT:-443}
      - SCREEPS_PROTOCOL=${SCREEPS_PROTOCOL:-https}
      - SCREEPS_SHARD=${SCREEPS_SHARD:-shard3}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - GITHUB_BASE_BRANCH=${GITHUB_BASE_BRANCH:-main}
      - AUTONOMY_LEVEL=${AUTONOMY_LEVEL:-manual}
      - TIMEOUT=${TIMEOUT:-45}
    command: node dist/agent.js --task=${AGENT_TASK:-run_tests}
    stdin_open: true
    tty: true
