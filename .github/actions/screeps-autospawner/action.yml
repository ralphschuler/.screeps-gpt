name: "Screeps AutoSpawner"
description: "Automatically checks spawn status and triggers respawn if needed after deployment"
inputs:
  screeps-token:
    description: "Screeps API token for authentication"
    required: true
  screeps-host:
    description: "Screeps server hostname"
    required: false
    default: "screeps.com"
  screeps-protocol:
    description: "Protocol (http or https)"
    required: false
    default: "https"
  screeps-port:
    description: "Screeps server port"
    required: false
    default: "443"
  screeps-path:
    description: "Screeps server path"
    required: false
    default: "/"
outputs:
  status:
    description: "Spawn status after check (normal, lost, empty, or spawned)"
    value: ${{ steps.autospawn.outputs.status }}
  action-taken:
    description: "Action taken by the autospawner (none, respawned, spawn_placed, blocked, failed)"
    value: ${{ steps.autospawn.outputs.action }}
  circuit_breaker_until:
    description: "Timestamp when circuit breaker expires (if active)"
    value: ${{ steps.autospawn.outputs.circuit_breaker_until }}
runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: .nvmrc

    - name: Check spawn status and auto-respawn
      id: autospawn
      shell: bash
      env:
        SCREEPS_TOKEN: ${{ inputs.screeps-token }}
        SCREEPS_HOST: ${{ inputs.screeps-host }}
        SCREEPS_PROTOCOL: ${{ inputs.screeps-protocol }}
        SCREEPS_PORT: ${{ inputs.screeps-port }}
        SCREEPS_PATH: ${{ inputs.screeps-path }}
      run: |
        cd ${{ github.action_path }}/../../..
        yarn tsx packages/utilities/scripts/screeps-autospawn.ts
