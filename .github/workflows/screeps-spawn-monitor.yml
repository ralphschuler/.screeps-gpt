---
name: Screeps Spawn Monitor

on:
  schedule:
    # Run every 30 minutes to check spawn status
    # Note: screeps-monitoring.yml runs same interval for telemetry
    - cron: "*/30 * * * *"
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: read
  issues: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  check-spawn:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Check spawn status and auto-respawn
        id: autospawn
        uses: ./.github/actions/screeps-autospawner
        with:
          screeps-token: ${{ secrets.SCREEPS_TOKEN }}
          screeps-host: ${{ vars.SCREEPS_HOST }}
          screeps-port: ${{ vars.SCREEPS_PORT }}
          screeps-protocol: ${{ vars.SCREEPS_PROTOCOL }}
          screeps-path: ${{ vars.SCREEPS_PATH }}

      - name: Notify on spawn loss
        if: steps.autospawn.outputs.action-taken == 'respawned'
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "ðŸš¨ Screeps Bot Respawned"
          body: >-
            Bot lost all spawns and was automatically respawned.
            Status: ${{ steps.autospawn.outputs.status }}
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "5"

      - name: Notify on spawn placement
        if: steps.autospawn.outputs.action-taken == 'spawn_placed'
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "ðŸ“ Screeps Spawn Placed"
          body: >-
            Bot spawn was automatically placed after respawn.
            Status: ${{ steps.autospawn.outputs.status }}
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "4"

      - name: Notify on circuit breaker
        if: steps.autospawn.outputs.action-taken == 'blocked'
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "ðŸš« Screeps Circuit Breaker Active"
          body: >-
            Spawn recovery blocked by circuit breaker.
            Too many failed attempts. Manual intervention required.
            Circuit breaker until:
            ${{ steps.autospawn.outputs.circuit_breaker_until }}
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "5"

      - name: Create escalation issue on circuit breaker
        if: steps.autospawn.outputs.action-taken == 'blocked'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš« Spawn Recovery Circuit Breaker Active' +
              ' - Manual Intervention Required';
            const body = `## Circuit Breaker Escalation

            The autonomous spawn recovery system has activated its
            circuit breaker due to repeated failures.

            **Details:**
            - Circuit breaker active until: \`${{
              steps.autospawn.outputs.circuit_breaker_until }}\`
            - Workflow run: ${{ github.server_url }}/${{
              github.repository }}/actions/runs/${{ github.run_id }}

            **Required Actions:**
            1. **Manually place spawn** via Screeps web interface at
               https://screeps.com
            2. **Investigate root cause** of repeated spawn placement
               failures
            3. **Reset circuit breaker** after manual recovery
               (if needed)

            **To reset circuit breaker:**
            \`\`\`bash
            yarn tsx packages/utilities/scripts/reset-circuit-breaker.ts
            \`\`\`

            **Related Issues:**
            - Check spawn recovery logs in \`reports/spawn-recovery/\`
            - Review recent workflow runs for failure patterns

            **Context:**
            This circuit breaker prevents infinite spawn placement loops
            by limiting automatic recovery to 3 attempts per 24-hour
            window. Manual intervention is now required to restore bot
            operation.`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automation,priority/critical,state/blocked'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Circuit Breaker Active')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Circuit breaker still active as of ${
                  new Date().toISOString()}.\n\n${body}`
              });
              console.log(
                `Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automation', 'priority/critical',
                  'state/blocked', 'monitoring']
              });
              console.log(
                `Created escalation issue #${issue.data.number}`);
            }

      - name: Notify on spawn check failure
        if: failure()
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "âŒ Screeps Spawn Check Failed"
          body: >-
            Automatic spawn check or respawn failed.
            Manual intervention required.
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "5"
