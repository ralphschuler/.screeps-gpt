---
name: Screeps Monitoring

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_run:
    workflows:
      - "Deploy Screeps AI"
  workflow_dispatch:

# SECURITY NOTE:
# The 'contents: write' permission is required to enable committing
# bot state snapshots. This workflow pushes snapshot data directly to
# the repository every 30 minutes.
# This permission grant has been reviewed and documented in the PR.
permissions:
  contents: write
  issues: write
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Run autonomous strategic monitoring with PTR analysis
        uses: ./.github/actions/copilot-exec
        env:
          REPO_NAME: "${{ github.repository }}"
          RUN_ID: "${{ github.run_id }}"
          RUN_URL: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ secrets.SCREEPS_HOST }}
          SCREEPS_SHARD: ${{ secrets.SCREEPS_SHARD }}
          SCREEPS_PORT: ${{ secrets.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ secrets.SCREEPS_PROTOCOL }}
          SCREEPS_STATS_TOKEN: ${{ secrets.SCREEPS_STATS_TOKEN }}
          SCREEPS_STATS_HOST: ${{ secrets.SCREEPS_STATS_HOST }}
          SCREEPS_STATS_API: ${{ secrets.SCREEPS_STATS_API }}
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          prompt-path: .github/copilot/prompts/screeps-monitor
          output-path: >-
            reports/copilot/screeps-monitor-${{ github.run_id }}.log
          additional-mcp-config: >-
            @.github/mcp/screeps-mcp.json
          timeout: "40"
          verbose: "true"

      - name: Collect bot state snapshot
        id: collect_snapshot
        if: success()
        run: |
          npx tsx packages/utilities/scripts/collect-bot-snapshot.ts || \
            echo "::warning::Snapshot collection failed (stats may not \
            be available)"
        continue-on-error: true

      - name: Generate analytics data from snapshots
        id: generate_analytics
        if: success() && steps.collect_snapshot.outcome == 'success'
        run: |
          npx tsx packages/utilities/scripts/generate-analytics.ts || \
            echo "::warning::Analytics generation failed (no snapshots yet)"
        continue-on-error: true

      - name: Fetch profiler data from console
        if: always()
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ secrets.SCREEPS_HOST }}
          SCREEPS_SHARD: ${{ secrets.SCREEPS_SHARD }}
          SCREEPS_PORT: ${{ secrets.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ secrets.SCREEPS_PROTOCOL }}
        run: |
          npx tsx packages/utilities/scripts/fetch-profiler-console.ts || \
            echo "::warning::Profiler data fetch failed (may not be enabled)"
        continue-on-error: true

      - name: Validate profiler health
        if: always()
        run: |
          npx tsx packages/utilities/scripts/check-profiler-health.ts || \
            echo "::warning::Profiler health check failed or has warnings"
        continue-on-error: true

      - name: Bot Health Check with Graduated Detection
        id: health_check
        if: always()
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ secrets.SCREEPS_HOST }}
          SCREEPS_SHARD: ${{ secrets.SCREEPS_SHARD }}
          SCREEPS_PORT: ${{ secrets.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ secrets.SCREEPS_PROTOCOL }}
        run: |
          npx tsx packages/utilities/scripts/check-bot-health.ts || \
            echo "::warning::Bot health check completed with \
            warnings or failures"
        continue-on-error: true

      - name: Check for critical PTR alerts
        if: always()
        env:
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          EMAIL_NOTIFY_TO: ${{ vars.EMAIL_NOTIFY_TO }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
        run: |
          npx tsx packages/utilities/scripts/check-ptr-alerts.ts

      - name: Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: screeps-monitor-report-${{ github.run_id }}
          path: |
            reports/copilot/screeps-monitor-${{ github.run_id }}.log
            reports/profiler/latest.json
            reports/screeps-stats/latest.json
            reports/bot-snapshots/*.json
            reports/monitoring/health.json
            reports/monitoring/health-check-latest.json
            source/docs/analytics/data.json
          retention-days: 30

      - name: Commit bot snapshots and health state
        if: success() && steps.collect_snapshot.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email \
            "github-actions[bot]@users.noreply.github.com"

          # Add bot snapshots and health monitoring state
          if [ -d "reports/bot-snapshots" ] && \
            [ "$(ls -A reports/bot-snapshots/*.json 2>/dev/null)" ]; then
            git add reports/bot-snapshots/
          fi

          # Add analytics data when generated
          if [ -f "source/docs/analytics/data.json" ]; then
            git add source/docs/analytics/data.json
          fi

          # Add health monitoring state
          if [ -f "reports/monitoring/health.json" ]; then
            git add reports/monitoring/health.json
          fi

          # Commit when there are changes
          if git diff --cached --quiet; then
            echo "No snapshot or health state changes to commit"
          else
            git commit -m \
              "chore: update bot state snapshots and health \
              monitoring [skip ci]"
            # Retry loop for pull/rebase/push to handle concurrent runs
            ATTEMPTS=0
            MAX_ATTEMPTS=5
            SLEEP_SECONDS=10
            SUCCESS=0
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              git pull --rebase --autostash origin \
                "${GITHUB_REF##*/}" || {
                echo "::warning::Failed to rebase before push \
                  (may be merge conflict)";
                ATTEMPTS=$((ATTEMPTS+1))
                sleep $SLEEP_SECONDS
                continue
              }
              git push && SUCCESS=1 && break
              echo "::warning::Failed to push snapshots (may be \
                permissions issue or concurrent update), retrying..."
              ATTEMPTS=$((ATTEMPTS+1))
              sleep $SLEEP_SECONDS
            done
            if [ $SUCCESS -eq 0 ]; then
              echo "::warning::Failed to push snapshots after \
                $MAX_ATTEMPTS attempts (concurrent workflow runs may \
                have caused conflicts)"
            fi
          fi
