---
name: Screeps Monitoring

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_run:
    workflows:
      - "Deploy Screeps AI"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Run autonomous strategic monitoring with PTR analysis
        uses: ./.github/actions/copilot-exec
        env:
          REPO_NAME: "${{ github.repository }}"
          RUN_ID: "${{ github.run_id }}"
          RUN_URL: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_EMAIL: ${{ secrets.SCREEPS_EMAIL }}
          SCREEPS_PASSWORD: ${{ secrets.SCREEPS_PASSWORD }}
          SCREEPS_HOST: ${{ secrets.SCREEPS_HOST }}
          SCREEPS_SHARD: ${{ secrets.SCREEPS_SHARD }}
          SCREEPS_PORT: ${{ secrets.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ secrets.SCREEPS_PROTOCOL }}
          SCREEPS_STATS_TOKEN: ${{ secrets.SCREEPS_STATS_TOKEN }}
          SCREEPS_STATS_HOST: ${{ secrets.SCREEPS_STATS_HOST }}
          SCREEPS_STATS_API: ${{ secrets.SCREEPS_STATS_API }}
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          prompt-path: .github/copilot/prompts/screeps-monitor
          output-path: >-
            reports/copilot/screeps-monitor-${{ github.run_id }}.log
          additional-mcp-config: >-
            @.github/mcp/screeps-mcp.json
          timeout: "40"
          verbose: "true"

      - name: Fetch profiler data from console
        if: always()
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ secrets.SCREEPS_HOST }}
          SCREEPS_SHARD: ${{ secrets.SCREEPS_SHARD }}
          SCREEPS_PORT: ${{ secrets.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ secrets.SCREEPS_PROTOCOL }}
        run: |
          npx tsx scripts/fetch-profiler-console.ts || \
            echo "Profiler data fetch failed (may not be enabled)"

      - name: Collect bot state snapshot
        if: always()
        run: |
          npx tsx scripts/collect-bot-snapshot.ts || \
            echo "Snapshot collection failed (stats may not be available)"

      - name: Check for critical PTR alerts
        if: always()
        env:
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          EMAIL_NOTIFY_TO: ${{ vars.EMAIL_NOTIFY_TO }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
        run: |
          npx tsx scripts/check-ptr-alerts.ts

      - name: Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: screeps-monitor-report-${{ github.run_id }}
          path: |
            reports/copilot/screeps-monitor-${{ github.run_id }}.log
            reports/profiler/latest.json
            reports/screeps-stats/latest.json
            reports/bot-snapshots/*.json
          retention-days: 30

      - name: Commit bot snapshots
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email \
            "github-actions[bot]@users.noreply.github.com"
          git add reports/bot-snapshots/
          if git diff --cached --quiet; then
            echo "No snapshot changes to commit"
          else
            git commit -m "chore: update bot state snapshots [skip ci]"
            git pull --rebase origin "${GITHUB_REF##*/}" || \
              { echo "Failed to rebase before push (may be merge conflict)"; exit 1; }
            git push || \
              echo "Failed to push snapshots (may be permissions issue)"
          fi
