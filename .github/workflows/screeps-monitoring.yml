---
name: Screeps Monitoring

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_run:
    workflows:
      - "Deploy Screeps AI"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Run autonomous strategic monitoring with PTR analysis
        uses: ./.github/actions/copilot-exec
        env:
          REPO_NAME: "${{ github.repository }}"
          RUN_ID: "${{ github.run_id }}"
          RUN_URL: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_EMAIL: ${{ secrets.SCREEPS_EMAIL }}
          SCREEPS_PASSWORD: ${{ secrets.SCREEPS_PASSWORD }}
          SCREEPS_HOST: ${{ secrets.SCREEPS_HOST }}
          SCREEPS_SHARD: ${{ secrets.SCREEPS_SHARD }}
          SCREEPS_PORT: ${{ secrets.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ secrets.SCREEPS_PROTOCOL }}
          SCREEPS_STATS_TOKEN: ${{ secrets.SCREEPS_STATS_TOKEN }}
          SCREEPS_STATS_HOST: ${{ secrets.SCREEPS_STATS_HOST }}
          SCREEPS_STATS_API: ${{ secrets.SCREEPS_STATS_API }}
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          prompt-path: .github/copilot/prompts/screeps-monitor
          output-path: >-
            reports/copilot/screeps-monitor-${{ github.run_id }}.log
          additional-mcp-config: >-
            @.github/mcp/screeps-mcp.json
          timeout: "40"
          verbose: "true"

      - name: Check for critical PTR alerts
        if: always()
        env:
          PUSH_TOKEN: ${{ secrets.PUSH_TOKEN }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          npx tsx scripts/check-ptr-alerts.ts

      - name: Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: screeps-monitor-report-${{ github.run_id }}
          path: reports/copilot/screeps-monitor-${{ github.run_id }}.log
          retention-days: 30
