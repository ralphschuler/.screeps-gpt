---
name: Copilot CI AutoFix

on:
  workflow_run:
    workflows:
      - "Post Merge Release"
      - "Deploy Screeps AI"
      - "Copilot Repository Audit"
      - "Copilot Issue Triage"
      - "Copilot Todo PR"
      - "Copilot Daily Todo Prioritization"
      - "Copilot Email Triage"
      - "Copilot Spec-Kit"
      - "Daily Autonomous Bot Monitor"
      - "Dependabot Auto Merge"
      - "Publish Documentation Site"
      - "Sync Labels"
      - "Screeps Stats Monitor"
      - "Screeps Spawn Monitor"
      - "Guard - Build"
      - "Guard - Coverage"
      - "Guard - Format"
      - "Guard - Lint"
      - "Guard - Documentation Tests"
      - "Guard - E2E Tests"
      - "Guard - Regression Tests"
      - "Guard - Unit Tests"
      - "Guard - Version Index"
      - "Guard - YAML Lint"
    types:
      - completed

permissions:
  actions: read
  contents: write
  issues: write
  pull-requests: write

jobs:
  autofix:
    if: >-
      ${{ github.event.workflow_run.conclusion == 'failure'
      && github.event.workflow_run.name != 'Copilot CI AutoFix' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Run Copilot CI auto-fix
        uses: ./.github/actions/copilot-exec
        env:
          REPO_NAME: "${{ github.repository }}"
          WORKFLOW_NAME: ${{ toJSON(github.event.workflow_run.name) }}
          RUN_ID: "${{ github.event.workflow_run.id }}"
          RUN_HTML_URL: >-
            ${{ toJSON(github.event.workflow_run.html_url ||
            format('https://github.com/{0}/actions/runs/{1}',
            github.repository, github.event.workflow_run.id)) }}
          TRIGGER_EVENT: >-
            ${{ toJSON(github.event.workflow_run.event) }}
          EVENT_PATH: "${{ github.event_path }}"
          WORKSPACE: "${{ github.workspace }}"
        with:
          force-response: true
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          prompt-path: .github/copilot/prompts/ci-autofix
          output-path: >-
            reports/copilot/ci-autofix-${{ github.run_id }}.log
