---
name: Copilot CI AutoFix

on:
  workflow_run:
    workflows:
      - "Post Merge Release"
      - "Deploy Screeps AI"
      - "Copilot Repository Audit"
      - "Copilot Issue Triage"
      - "Copilot Todo PR"
      - "Copilot Daily Todo Prioritization"
      - "Copilot Email Triage"
      - "Copilot Spec-Kit"
      - "Screeps Monitoring"
      - "Dependabot Auto Merge"
      - "Publish Documentation Site"
      - "Sync Labels"
      - "Screeps Spawn Monitor"
      - "Guard - Build"
      - "Guard - Coverage"
      - "Guard - Format"
      - "Guard - Lint"
      - "Guard - Documentation Tests"
      - "Guard - E2E Tests"
      - "Guard - Regression Tests"
      - "Guard - Unit Tests"
      - "Guard - Version Index"
      - "Guard - YAML Lint"
    types:
      - completed

permissions:
  actions: read
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ci-autofix-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  autofix:
    if: >-
      ${{ github.event.workflow_run.conclusion == 'failure'
      && github.event.workflow_run.name != 'Copilot CI AutoFix' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Run Copilot CI auto-fix
        uses: ./.github/actions/copilot-exec
        env:
          REPO_NAME: "${{ github.repository }}"
          WORKFLOW_NAME: ${{ toJSON(github.event.workflow_run.name) }}
          RUN_ID: "${{ github.event.workflow_run.id }}"
          RUN_HTML_URL: >-
            ${{ toJSON(github.event.workflow_run.html_url ||
            format('https://github.com/{0}/actions/runs/{1}',
            github.repository, github.event.workflow_run.id)) }}
          TRIGGER_EVENT: >-
            ${{ toJSON(github.event.workflow_run.event) }}
          EVENT_PATH: "${{ github.event_path }}"
          WORKSPACE: "${{ github.workspace }}"
        with:
          force-response: true
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          prompt-path: .github/copilot/prompts/ci-autofix
          output-path: >-
            reports/copilot/ci-autofix-${{ github.run_id }}.log
          timeout: "45"
          verbose: "true"

      - name: Notify CI failure via email
        if: always()
        uses: ./.github/actions/send-email-notification
        with:
          smtp-host: ${{ secrets.SMTP_HOST }}
          smtp-port: ${{ secrets.SMTP_PORT || '587' }}
          smtp-user: ${{ secrets.SMTP_USER }}
          smtp-password: ${{ secrets.SMTP_PASSWORD }}
          smtp-from: ${{ secrets.SMTP_FROM || secrets.SMTP_USER }}
          to: ${{ vars.EMAIL_NOTIFY_TO }}
          subject: >-
            [CI FAILURE] ${{ github.event.workflow_run.name }} -
            ${{ github.repository }}
          body: |
            CI/CD Workflow Failure Detected
            ================================

            Workflow: ${{ github.event.workflow_run.name }}
            Repository: ${{ github.repository }}
            Run ID: ${{ github.event.workflow_run.id }}
            Trigger Event: ${{ github.event.workflow_run.event }}

            The CI/CD workflow has failed and the auto-fix process
            has been triggered.

            View Details: ${{ github.event.workflow_run.html_url }}

            Timestamp: ${{ github.event.workflow_run.updated_at }}

            This is an automated alert from the Screeps CI/CD
            monitoring system.
          priority: "high"
