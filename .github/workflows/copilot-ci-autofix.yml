---
name: Copilot CI AutoFix

on:
  workflow_run:
    workflows:
      - "Post Merge Release"
      - "Deploy Screeps AI"
      - "Copilot Repository Audit"
      - "Copilot Issue Triage"
      - "Copilot Todo PR"
      - "Copilot Daily Todo Prioritization"
      - "Copilot Email Triage"
      - "Copilot Spec-Kit"
      - "Screeps Monitoring"
      - "Dependabot Auto Merge"
      - "Publish Documentation Site"
      - "Sync Labels"
      - "Screeps Spawn Monitor"
      - "Guard - Build"
      - "Guard - Coverage"
      - "Guard - Format"
      - "Guard - Lint"
      - "Guard - Documentation Tests"
      - "Guard - E2E Tests"
      - "Guard - Regression Tests"
      - "Guard - Unit Tests"
      - "Guard - Version Index"
      - "Guard - YAML Lint"
    types:
      - completed

permissions:
  actions: read
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: ci-autofix-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

jobs:
  check-circuit-breaker:
    if: >-
      ${{ github.event.workflow_run.conclusion == 'failure'
      && github.event.workflow_run.name != 'Copilot CI AutoFix' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
      consecutive-failures: ${{ steps.check.outputs.consecutive-failures }}
      failure-key: ${{ steps.check.outputs.failure-key }}
    steps:
      - name: Check circuit breaker state
        id: check
        uses: actions/github-script@v8
        with:
          script: |
            const MAX_CONSECUTIVE_FAILURES = 3;
            const BACKOFF_MINUTES = 15;

            // Create unique key for failure (workflow + branch)
            const failureKey = [
              context.payload.workflow_run.name,
              context.payload.workflow_run.head_branch
            ].join('-');

            core.info(`Checking circuit breaker for: ${failureKey}`);
            core.info(
              `Failed workflow: ${context.payload.workflow_run.name}`
            );
            core.info(
              `Branch: ${context.payload.workflow_run.head_branch}`
            );

            // Query recent autofix runs
            const params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'copilot-ci-autofix.yml',
              per_page: 20
            };
            const { data: autofixRuns } =
              await github.rest.actions.listWorkflowRuns(params);

            // Count consecutive failures
            let consecutiveFailures = 0;
            let lastFailureTime = null;

            for (const run of autofixRuns.workflow_runs) {
              if (run.status !== 'completed') continue;

              // Count action_required or failure conclusions
              const failed = run.conclusion === 'action_required' ||
                run.conclusion === 'failure';

              if (failed) {
                consecutiveFailures++;
                if (!lastFailureTime) {
                  lastFailureTime = new Date(run.updated_at);
                }
              } else if (run.conclusion === 'success') {
                break;  // Reset circuit on success
              }
            }

            core.info(
              `Consecutive failures detected: ${consecutiveFailures}`
            );

            // Check if we've exceeded the limit
            if (consecutiveFailures >= MAX_CONSECUTIVE_FAILURES) {
              if (lastFailureTime) {
                const now = new Date();
                const elapsed =
                  (now - lastFailureTime) / (1000 * 60);

                if (elapsed < BACKOFF_MINUTES) {
                  const msg = [
                    `â›” Circuit breaker OPEN:`,
                    `${consecutiveFailures} consecutive failures.`,
                    `Waiting ${BACKOFF_MINUTES} minutes`,
                    `(${elapsed.toFixed(1)} elapsed).`
                  ].join(' ');
                  core.warning(msg);
                  core.setOutput('should-run', 'false');
                  core.setOutput(
                    'consecutive-failures',
                    consecutiveFailures
                  );
                  core.setOutput('failure-key', failureKey);
                  return;
                }

                const retry = [
                  `âš ï¸ Circuit breaker backoff expired.`,
                  `Attempting fix after`,
                  `${elapsed.toFixed(1)} minutes.`
                ].join(' ');
                core.info(retry);
              }
            }

            const allowed = [
              `âœ… Circuit breaker CLOSED:`,
              `Allowing autofix`,
              `(${consecutiveFailures}/${MAX_CONSECUTIVE_FAILURES})`,
            ].join(' ');
            core.info(allowed);
            core.setOutput('should-run', 'true');
            core.setOutput('consecutive-failures', consecutiveFailures);
            core.setOutput('failure-key', failureKey);

  autofix:
    needs: check-circuit-breaker
    if: needs.check-circuit-breaker.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Log circuit breaker status
        run: |
          echo "ðŸ”„ CI Autofix Attempt"
          echo "Consecutive failures: \
          ${{ needs.check-circuit-breaker.outputs.consecutive-failures }}/3"
          echo "Failure context: \
          ${{ needs.check-circuit-breaker.outputs.failure-key }}"
          echo "Failed workflow: ${{ github.event.workflow_run.name }}"
          echo "Run ID: ${{ github.event.workflow_run.id }}"

      - name: Run Copilot CI auto-fix
        uses: ./.github/actions/copilot-ci-autofix-agent
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          workflow-name: ${{ toJSON(github.event.workflow_run.name) }}
          run-id: ${{ github.event.workflow_run.id }}
          run-url: >-
            ${{ toJSON(github.event.workflow_run.html_url ||
            format('https://github.com/{0}/actions/runs/{1}',
            github.repository, github.event.workflow_run.id)) }}
          trigger-event: >-
            ${{ toJSON(github.event.workflow_run.event) }}

  escalate-to-manual:
    needs: check-circuit-breaker
    if: needs.check-circuit-breaker.outputs.should-run == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      issues: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Create manual review issue
        uses: actions/github-script@v8
        with:
          script: |
            const failureKey =
              '${{ needs.check-circuit-breaker.outputs.failure-key }}';
            const consecutiveFailures =
              '${{ needs.check-circuit-breaker.outputs.consecutive-failures }}';
            const workflowName =
              '${{ github.event.workflow_run.name }}';
            const runUrl = '${{ github.event.workflow_run.html_url }}';
            const branch =
              '${{ github.event.workflow_run.head_branch }}';

            // Check for existing open issue
            const listParams = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automation,ci-autofix-escalation',
              per_page: 10
            };
            const { data: existingIssues } =
              await github.rest.issues.listForRepo(listParams);

            // Look for issue with same workflow
            const existingIssue = existingIssues.find(issue =>
              issue.title.includes(workflowName) &&
              issue.title.includes(branch)
            );

            if (existingIssue) {
              core.info(
                `Issue already exists: ${existingIssue.html_url}`
              );

              // Add comment to existing issue
              const comment = {
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: [
                  '## Circuit Breaker Update',
                  '',
                  'The CI autofix workflow continues to be blocked.',
                  '',
                  `**Status:** ${consecutiveFailures} failures`,
                  `**Latest Run:** ${runUrl}`,
                  `**Timestamp:** ${new Date().toISOString()}`,
                  '',
                  'Manual intervention is still required.'
                ].join('\n')
              };
              await github.rest.issues.createComment(comment);

              return;
            }

            // Create new issue
            const title = [
              'fix(ci): Manual review required -',
              workflowName,
              'failure on',
              branch
            ].join(' ');

            const labels = [
              'automation',
              'ci-autofix-escalation',
              'type/bug',
              'priority/high',
              'state/pending'
            ];

            const body = [
              '## CI Autofix Circuit Breaker Triggered',
              '',
              'The automated CI fix workflow has been blocked',
              `after **${consecutiveFailures}** consecutive failures.`,
              '',
              '### Failure Details',
              '',
              `- **Workflow:** ${workflowName}`,
              `- **Branch:** ${branch}`,
              `- **Latest Run:** ${runUrl}`,
              `- **Failure Context:** \`${failureKey}\``,
              '',
              '### Circuit Breaker Status',
              '',
              'â›” **OPEN** - Autofix attempts are throttled.',
              '',
              'The circuit breaker will:',
              '- Block autofix for 15 minutes after last failure',
              '- Allow one retry after backoff period',
              '- Reopen circuit if retry fails',
              '',
              '### Required Actions',
              '',
              `1. **Review logs:** ${runUrl}`,
              '2. **Identify root cause** of the failure',
              '3. **Apply manual fix** if cannot auto-correct',
              '4. **Close issue** once problem is resolved',
              '',
              '### Context',
              '',
              'The CI autofix workflow automatically resolves',
              'common CI failures (linting, formatting, etc).',
              'When it cannot resolve a failure, it retries up',
              'to 3 times before triggering this breaker.',
              '',
              'This escalation indicates:',
              '- Failure is too complex for auto-resolution, OR',
              '- Autofix logic needs update for this type, OR',
              '- Systemic issue prevents fix application',
              '',
              '### Documentation',
              '',
              '- [CI Autofix Workflow]' +
                '(.github/workflows/copilot-ci-autofix.yml)',
              '- [Autofix Agent Configuration]' +
                '(.github/copilot/prompts/ci-autofix)',
              '',
              '---',
              '*Automatically created by CI autofix breaker.*'
            ].join('\n');

            const createParams = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              labels,
              body
            };
            const { data: issue } =
              await github.rest.issues.create(createParams);

            core.info(`Created escalation issue: ${issue.html_url}`);

  notify-failure:
    needs: [check-circuit-breaker, autofix]
    if: always() && needs.autofix.result != 'skipped'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Notify CI failure via email
        if: always()
        uses: ./.github/actions/send-email-notification
        with:
          smtp-host: ${{ secrets.SMTP_HOST }}
          smtp-port: ${{ secrets.SMTP_PORT || '587' }}
          smtp-user: ${{ secrets.SMTP_USER }}
          smtp-password: ${{ secrets.SMTP_PASSWORD }}
          smtp-from: ${{ secrets.SMTP_FROM || secrets.SMTP_USER }}
          to: ${{ vars.EMAIL_NOTIFY_TO }}
          subject: >-
            [CI FAILURE] ${{ github.event.workflow_run.name }} -
            ${{ github.repository }}
          body: |
            CI/CD Workflow Failure Detected
            ================================

            Workflow: ${{ github.event.workflow_run.name }}
            Repository: ${{ github.repository }}
            Run ID: ${{ github.event.workflow_run.id }}
            Trigger Event: ${{ github.event.workflow_run.event }}

            The CI/CD workflow has failed and the auto-fix process
            has been triggered.

            View Details: ${{ github.event.workflow_run.html_url }}

            Timestamp: ${{ github.event.workflow_run.updated_at }}

            This is an automated alert from the Screeps CI/CD
            monitoring system.
          priority: "high"
