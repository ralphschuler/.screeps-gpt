name: Copilot CI AutoFix

on:
  workflow_run:
    workflows:
      - Quality Gate
    types:
      - completed

permissions:
  actions: read
  contents: write
  issues: write
  pull-requests: write

jobs:
  autofix:
    if: >-
      ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Run Copilot CI auto-fix
        uses: ./.github/actions/copilot-exec
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          prompt-path: .github/copilot/prompts/ci-autofix.md
          output-path: reports/copilot/ci-autofix-${{ github.run_id }}.log
          substitutions: |
            {
              "REPO_NAME": "${{ github.repository }}",
              "WORKFLOW_NAME": ${{ toJSON(github.event.workflow_run.name) }},
              "RUN_ID": "${{ github.event.workflow_run.id }}",
              "RUN_HTML_URL": ${{ toJSON(github.event.workflow_run.html_url || format('https://github.com/{0}/actions/runs/{1}', github.repository, github.event.workflow_run.id)) }},
              "TRIGGER_EVENT": ${{ toJSON(github.event.workflow_run.event) }},
              "EVENT_PATH": "${{ github.event_path }}",
              "WORKSPACE": "${{ github.workspace }}"
            }
