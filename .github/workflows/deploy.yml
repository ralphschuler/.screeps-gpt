---
name: Deploy Screeps AI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (leave empty for current version)'
        required: false
        type: string
permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Use GitHub environment for deployment protection rules
    environment:
      name: production
      url: https://screeps.com
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        shell: bash
        run: |
          # Extract version from tag or manual input
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "::notice::Deploying manually specified version $VERSION"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # For tag push events, extract version from tag ref
            VERSION="${{ github.ref_name }}"
            echo "::notice::Deploying version $VERSION from tag push"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual dispatch without version input, use latest tag
            VERSION=$(git describe --tags --abbrev=0)
            echo "::notice::Deploying latest version $VERSION via dispatch"
          else
            echo "::error::Unknown event type for deployment"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1
      - name: Install dependencies
        run: bun install --no-optional
      - name: Cache build output
        id: cache-build
        uses: actions/cache@v4
        with:
          path: dist
          key: >-
            build-${{ runner.os }}-${{
            hashFiles('packages/bot/src/**/*',
            'packages/utilities/scripts/build.ts',
            'tsconfig.json', 'bun.lock') }}
          restore-keys: |
            build-${{ runner.os }}-
      - name: Build and deploy
        id: deploy
        env:
          PROFILER_ENABLED: ${{ vars.PROFILER_ENABLED || 'true' }}
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ vars.SCREEPS_HOST }}
          SCREEPS_PORT: ${{ vars.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ vars.SCREEPS_PROTOCOL }}
          SCREEPS_BRANCH: ${{ vars.SCREEPS_BRANCH }}
          SCREEPS_PATH: ${{ vars.SCREEPS_PATH }}
        run: bun run deploy

      - name: Notify deployment success
        if: success()
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "Screeps Deployment Success"
          body: >-
            Version ${{ steps.get_version.outputs.version }} deployed
            successfully to production
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "3"

      - name: Check spawn status and auto-respawn
        if: success()
        id: autospawn
        uses: ./.github/actions/screeps-autospawner
        with:
          screeps-token: ${{ secrets.SCREEPS_TOKEN }}
          screeps-host: ${{ vars.SCREEPS_HOST }}
          screeps-port: ${{ vars.SCREEPS_PORT }}
          screeps-protocol: ${{ vars.SCREEPS_PROTOCOL }}
          screeps-path: ${{ vars.SCREEPS_PATH }}

      - name: Notify deployment failure
        if: failure()
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "Screeps Deployment Failed"
          body: >-
            Version ${{ steps.get_version.outputs.version }} deployment
            failed - immediate attention required
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "5"

      - name: Send email notification for deployment failure
        if: failure()
        uses: ./.github/actions/send-email-notification
        with:
          smtp-host: ${{ secrets.SMTP_HOST }}
          smtp-port: ${{ secrets.SMTP_PORT || '587' }}
          smtp-user: ${{ secrets.SMTP_USER }}
          smtp-password: ${{ secrets.SMTP_PASSWORD }}
          smtp-from: ${{ secrets.SMTP_FROM || secrets.SMTP_USER }}
          to: ${{ vars.EMAIL_NOTIFY_TO }}
          subject: >-
            [DEPLOYMENT FAILED] Screeps AI Deployment -
            ${{ github.repository }}
          body: |
            Screeps AI Deployment Failed
            ============================

            Version: ${{ steps.get_version.outputs.version }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Run ID: ${{ github.run_id }}

            The deployment has failed and requires immediate
            attention.

            View Details:
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}

            Timestamp: ${{ github.event.head_commit.timestamp }}

            This is a critical automated alert from the Screeps
            deployment system.
          priority: "high"
