---
name: Deploy Screeps AI

on:
  workflow_run:
    workflows: ["Post Merge Release"]
    types:
      - completed
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (leave empty for current version)'
        required: false
        type: string
permissions:
  contents: read
  issues: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run if workflow_run succeeded, or if triggered by push/dispatch
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')
    # Use GitHub environment for deployment protection rules
    environment:
      name: production
      url: https://screeps.com
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get version
        id: get_version
        shell: bash
        run: |
          # Extract version from tag or manual input
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            echo "::notice::Deploying manually specified version $VERSION"
          elif [ "${{ github.event_name }}" = "push" ]; then
            # For tag push events, extract version from tag ref
            VERSION="${{ github.ref_name }}"
            echo "::notice::Deploying version $VERSION from tag push"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run events, get the latest tag
            VERSION=$(git describe --tags --abbrev=0)
            echo "::notice::Deploying version $VERSION from" \
              "post-merge-release completion"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual dispatch without version input, use latest tag
            VERSION=$(git describe --tags --abbrev=0)
            echo "::notice::Deploying latest version $VERSION via dispatch"
          else
            echo "::error::Unknown event type for deployment"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Cache build output
        id: cache-build
        uses: actions/cache@v4
        with:
          path: dist
          key: >-
            build-${{ runner.os }}-${{
            hashFiles('packages/bot/src/**/*',
            'packages/utilities/scripts/build.ts',
            'tsconfig.json', 'yarn.lock') }}
          restore-keys: |
            build-${{ runner.os }}-
      - name: Build and deploy
        id: deploy
        env:
          # PROFILER_ENABLED: Controls profiler integration
          # Valid values: 'true' or 'false'
          # Defaults to 'true' if not set.
          # Invalid values trigger a warning and default to 'true'.
          PROFILER_ENABLED: ${{ vars.PROFILER_ENABLED || 'true' }}
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ vars.SCREEPS_HOST }}
          SCREEPS_PORT: ${{ vars.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ vars.SCREEPS_PROTOCOL }}
          SCREEPS_BRANCH: ${{ vars.SCREEPS_BRANCH }}
          SCREEPS_PATH: ${{ vars.SCREEPS_PATH }}
        run: |
          yarn deploy
          echo "deployed_at=$(date -Iseconds)" >> "$GITHUB_OUTPUT"

      - name: Wait for deployment propagation
        if: success()
        run: |
          echo "::notice::Waiting 60 seconds for Screeps to load new code..."
          sleep 60

      - name: Collect bot snapshot for validation
        if: success()
        id: snapshot
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ vars.SCREEPS_HOST }}
          SCREEPS_PORT: ${{ vars.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ vars.SCREEPS_PROTOCOL }}
          SCREEPS_PATH: ${{ vars.SCREEPS_PATH }}
          SCREEPS_SHARD: ${{ vars.SCREEPS_SHARD || 'shard3' }}
        run: |
          echo "::notice::Collecting bot snapshot for health validation..."
          npx tsx packages/utilities/scripts/collect-bot-snapshot.ts || true
        continue-on-error: true

      - name: Validate deployment health
        if: success()
        id: health-check
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ vars.SCREEPS_HOST }}
          SCREEPS_PORT: ${{ vars.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ vars.SCREEPS_PROTOCOL }}
          SCREEPS_PATH: ${{ vars.SCREEPS_PATH }}
          SCREEPS_SHARD: ${{ vars.SCREEPS_SHARD || 'shard3' }}
        run: |
          echo "::notice::Validating deployment health..."
          set +e
          npx tsx packages/utilities/scripts/validate-deployment.ts
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 0 ]; then
            echo "validation_passed=true" >> "$GITHUB_OUTPUT"
            echo "recommendation=continue" >> "$GITHUB_OUTPUT"
            echo "::notice::Deployment health check PASSED"
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "validation_passed=true" >> "$GITHUB_OUTPUT"
            echo "recommendation=monitor" >> "$GITHUB_OUTPUT"
            echo "::warning::Deployment needs monitoring - no creeps detected"
          else
            echo "validation_passed=false" >> "$GITHUB_OUTPUT"
            echo "recommendation=rollback" >> "$GITHUB_OUTPUT"
            echo "failure_reason=zero_cpu" >> "$GITHUB_OUTPUT"
            echo "::error::Deployment validation FAILED - rollback recommended"
            exit 1
          fi

      - name: Rollback on validation failure
        if: failure() && steps.health-check.outputs.validation_passed == 'false'
        id: rollback
        env:
          PROFILER_ENABLED: ${{ vars.PROFILER_ENABLED || 'true' }}
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ vars.SCREEPS_HOST }}
          SCREEPS_PORT: ${{ vars.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ vars.SCREEPS_PROTOCOL }}
          SCREEPS_BRANCH: ${{ vars.SCREEPS_BRANCH }}
          SCREEPS_PATH: ${{ vars.SCREEPS_PATH }}
        run: |
          echo "::warning::Deployment failed validation - initiating rollback"

          # Get previous successful version
          CURRENT_TAG="${{ steps.get_version.outputs.version }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "::error::No previous tag found for rollback"
            echo "rollback_success=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "::notice::Rolling back from $CURRENT_TAG to $PREVIOUS_TAG"
          echo "previous_version=$PREVIOUS_TAG" >> "$GITHUB_OUTPUT"

          # Checkout previous version and rebuild
          git checkout "$PREVIOUS_TAG"
          yarn install --frozen-lockfile
          yarn build
          yarn deploy

          echo "rollback_success=true" >> "$GITHUB_OUTPUT"
          echo "::notice::Rollback complete - reverted to $PREVIOUS_TAG"

      - name: Create deployment failure issue
        if: >-
          failure() &&
          steps.health-check.outputs.validation_passed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const reason = '${{ steps.health-check.outputs.failure_reason }}' || 'unknown';
            const version = '${{ steps.get_version.outputs.version }}';
            const rollbackSuccess = '${{ steps.rollback.outputs.rollback_success }}' === 'true';
            const previousVersion = '${{ steps.rollback.outputs.previous_version }}' || 'unknown';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment validation failed: ${reason} (${version})`,
              labels: ['automation', 'type/bug', 'priority/critical', 'state/pending'],
              body: `## Deployment Validation Failure

            **Version:** ${version}
            **Failure Reason:** ${reason}
            **Rollback Attempted:** ${rollbackSuccess ? 'Yes' : 'No'}
            **Rolled Back To:** ${rollbackSuccess ? previousVersion : 'N/A'}

            ### Details

            The deployment health check detected a critical failure:
            - CPU usage was zero (code not executing)
            - Bot aliveness check failed

            ### Workflow Run

            - **Run ID:** ${context.runId}
            - **Workflow:** [View Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Commit:** ${context.sha}

            ### Manual Investigation Required

            Please investigate the following:
            1. Check the deployment logs for errors
            2. Verify the built code is syntactically correct
            3. Check Screeps console for runtime errors
            4. Review recent code changes that may have caused the failure

            ### Related Documentation

            - [Deployment Troubleshooting Guide](packages/docs/source/docs/operations/deployment-troubleshooting.md)
            - [Manual Rollback Runbook](packages/docs/source/docs/operations/deployment-rollback.md)

            ---
            _This issue was automatically created by the deployment workflow._
            `
            });

            console.log('Created deployment failure issue');

      - name: Notify deployment success
        if: >-
          success() &&
          steps.health-check.outputs.validation_passed == 'true'
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "Screeps Deployment Success"
          body: >-
            Version ${{ steps.get_version.outputs.version }} deployed
            and validated successfully
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "3"

      - name: Check spawn status and auto-respawn
        if: >-
          success() &&
          steps.health-check.outputs.validation_passed == 'true'
        id: autospawn
        uses: ./.github/actions/screeps-autospawner
        with:
          screeps-token: ${{ secrets.SCREEPS_TOKEN }}
          screeps-host: ${{ vars.SCREEPS_HOST }}
          screeps-port: ${{ vars.SCREEPS_PORT }}
          screeps-protocol: ${{ vars.SCREEPS_PROTOCOL }}
          screeps-path: ${{ vars.SCREEPS_PATH }}

      - name: Start profiler after deployment
        if: >-
          success() &&
          steps.health-check.outputs.validation_passed == 'true' &&
          (vars.PROFILER_ENABLED == 'true' || vars.PROFILER_ENABLED == '')
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ vars.SCREEPS_HOST }}
          SCREEPS_PORT: ${{ vars.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ vars.SCREEPS_PROTOCOL }}
          SCREEPS_PATH: ${{ vars.SCREEPS_PATH }}
          SCREEPS_SHARD: ${{ vars.SCREEPS_SHARD || 'shard3' }}
        run: |
          echo "::notice::Starting profiler via console command..."
          npx tsx packages/utilities/scripts/ensure-profiler-running.ts || \
            echo "::warning::Failed to start profiler automatically - \
            may require manual start via console"
        continue-on-error: true

      - name: Notify deployment failure
        if: failure()
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "Screeps Deployment Failed"
          body: >-
            Version ${{ steps.get_version.outputs.version }} deployment
            failed - immediate attention required
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "5"

      - name: Send email notification for deployment failure
        if: failure()
        uses: ./.github/actions/send-email-notification
        with:
          smtp-host: ${{ secrets.SMTP_HOST }}
          smtp-port: ${{ secrets.SMTP_PORT || '587' }}
          smtp-user: ${{ secrets.SMTP_USER }}
          smtp-password: ${{ secrets.SMTP_PASSWORD }}
          smtp-from: ${{ secrets.SMTP_FROM || secrets.SMTP_USER }}
          to: ${{ vars.EMAIL_NOTIFY_TO }}
          subject: >-
            [DEPLOYMENT FAILED] Screeps AI Deployment -
            ${{ github.repository }}
          body: |
            Screeps AI Deployment Failed
            ============================

            Version: ${{ steps.get_version.outputs.version }}
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Run ID: ${{ github.run_id }}

            The deployment has failed and requires immediate
            attention.

            View Details:
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}

            Timestamp: ${{ github.event.head_commit.timestamp }}

            This is a critical automated alert from the Screeps
            deployment system.
          priority: "high"
