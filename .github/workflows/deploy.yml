---
name: Deploy Screeps AI

on:
  push:
    tags:
      - "v*"
  release:
    types:
      - published

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Use GitHub environment for deployment protection rules
    environment:
      name: production
      url: https://screeps.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag push event - extract version from tag
            VERSION="${{ github.ref_name }}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "Deploying tagged version: $VERSION"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            # Release event - extract version from release tag
            VERSION="${{ github.event.release.tag_name }}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "Deploying release version: $VERSION"
          else
            echo "Unknown event type: ${{ github.event_name }}"
            exit 1
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1
      - name: Install dependencies
        run: bun install --no-optional
      - name: Cache build output
        id: cache-build
        uses: actions/cache@v4
        with:
          path: dist
          key: build-${{ runner.os }}-${{ hashFiles('src/**/*', 'scripts/build.ts', 'tsconfig.json', 'bun.lock') }}
          restore-keys: |
            build-${{ runner.os }}-
      - name: Build and deploy
        id: deploy
        env:
          SCREEPS_TOKEN: ${{ secrets.SCREEPS_TOKEN }}
          SCREEPS_HOST: ${{ vars.SCREEPS_HOST }}
          SCREEPS_PORT: ${{ vars.SCREEPS_PORT }}
          SCREEPS_PROTOCOL: ${{ vars.SCREEPS_PROTOCOL }}
          SCREEPS_BRANCH: ${{ vars.SCREEPS_BRANCH }}
          SCREEPS_PATH: ${{ vars.SCREEPS_PATH }}
        run: bun run deploy

      - name: Notify deployment success
        if: success()
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "Screeps Deployment Success"
          body: >-
            Version ${{ steps.get_version.outputs.version }} deployed
            successfully to production
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "3"

      - name: Notify deployment failure
        if: failure()
        uses: ./.github/actions/send-push-notification
        with:
          push-token: ${{ secrets.PUSH_TOKEN }}
          title: "Screeps Deployment Failed"
          body: >-
            Version ${{ steps.get_version.outputs.version }} deployment
            failed - immediate attention required
          link: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
          priority: "5"
