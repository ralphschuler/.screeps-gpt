name: CI Auto Issue

on:
  workflow_run:
    workflows:
      - "Post Merge Release"
      - "Deploy Screeps AI"
      - "Copilot Repository Audit"
      - "Copilot Issue Triage"
      - "Copilot Todo PR"
      - "Copilot Daily Todo Prioritization"
      - "Copilot Email Triage"
      - "Copilot Spec-Kit"
      - "Screeps Monitoring"
      - "Dependabot Auto Merge"
      - "Publish Documentation Site"
      - "Sync Labels"
      - "Screeps Spawn Monitor"
      - "Guard - Build"
      - "Guard - Coverage"
      - "Guard - Format"
      - "Guard - Lint"
      - "Guard - Documentation Tests"
      - "Guard - E2E Tests"
      - "Guard - Regression Tests"
      - "Guard - Unit Tests"
      - "Guard - Version Index"
      - "Guard - YAML Lint"
    types:
      - completed

concurrency:
  group: ci-auto-issue-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

permissions:
  actions: read
  issues: write

jobs:
  create-ci-failure-issue:
    # Only for failed workflow runs on push to main
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Create CI failure issue
        uses: actions/github-script@v8
        with:
          script: |
            const run = context.payload.workflow_run;

            // Get jobs for this run
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run.id,
            });

            const failedJobs = jobs.jobs.filter(job => job.conclusion === 'failure');
            const failedJobNames = failedJobs.map(job => job.name);

            // Collect failing steps for more specific "error" context
            const failedJobSteps = failedJobs.flatMap(job =>
              (job.steps || [])
                .filter(step => step.conclusion === 'failure')
                .map(step => `Job "${job.name}" â€“ Step "${step.name}"`)
            );

            // Use the first failing step (or fallback) as the "error" in the title
            const errorContext =
              failedJobSteps[0] ||
              (failedJobNames[0] ? `Job "${failedJobNames[0]}"` : run.name);

            const issueTitle = `CI Error: ${errorContext}`;

            const bodyLines = [
              '## CI Error Summary',
              '',
              `- **Workflow:** ${run.name}`,
              `- **Run ID:** ${run.id}`,
              `- **Run URL:** ${run.html_url}`,
              `- **Branch:** ${run.head_branch}`,
              `- **Commit:** ${run.head_sha.substring(0, 7)}`,
              `- **Triggered By:** ${run.actor.login}`,
              '',
              '### Failed Jobs',
              '',
              failedJobNames.length
                ? failedJobNames.map(name => `- ${name}`).join('\n')
                : '- (No job details found)',
              '',
              '### First Detected Error',
              '',
              failedJobSteps.length
                ? `- ${failedJobSteps[0]}`
                : '- Unable to determine failing step from workflow metadata.',
              '',
              '### Additional Information',
              '',
              'For full error details and stack traces, open the workflow run URL above and inspect the logs of the failing job(s).',
              '',
              '---',
              '*This issue was automatically created by the CI Auto Issue workflow.*',
            ];

            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: bodyLines.join('\n'),
              labels: [
                'automation',
                'ci-failure',
                'type/bug',
              ],
            });

            core.info(`Created CI error issue: ${issue.html_url}`);
