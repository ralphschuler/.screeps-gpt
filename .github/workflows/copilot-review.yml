---
name: Copilot Repository Audit

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
      - name: Run Copilot repository audit
        id: copilot
        uses: ./.github/actions/copilot-audit-agent
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-url: >-
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}
      - name: Upload copilot-exec logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: repository-audit-logs-${{ github.run_id }}
          path: |
            reports/copilot/repository-audit-${{ github.run_id }}.log
          retention-days: 30
