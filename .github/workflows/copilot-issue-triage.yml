---
name: Copilot Issue Triage

on:
  issues:
    types:
      - opened
      - reopened

permissions:
  contents: read
  issues: write
  repository-projects: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  triage:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
      - name: Run Copilot issue triage
        id: copilot
        uses: ./.github/actions/copilot-issue-agent
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          mode: triage
          issue-number: ${{ github.event.issue.number }}
          issue-title: ${{ toJSON(github.event.issue.title) }}
          issue-body: ${{ toJSON(github.event.issue.body || '') }}
          issue-url: ${{ toJSON(github.event.issue.html_url) }}
          issue-author: ${{ toJSON(github.event.issue.user.login) }}
      - name: Upload copilot-exec logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: >-
            issue-triage-logs-${{ github.event.issue.number }}-${{ github.run_id }}
          path: |
            reports/copilot/issue-triage-${{ github.event.issue.number }}.log
          retention-days: 30
      - name: Update project status after triage
        if: always()
        uses: ./.github/actions/project-sync
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          project-number: ${{ vars.PROJECT_NUMBER }}
          project-owner: ${{ vars.PROJECT_OWNER }}
          item-type: issue
          item-url: ${{ github.event.issue.html_url }}
          status-field: Backlog
          automation-state-field: Triaged
