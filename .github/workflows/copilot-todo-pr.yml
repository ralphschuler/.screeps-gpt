---
name: Copilot Todo PR

on:
  issues:
    types:
      - labeled

permissions:
  contents: write
  issues: write
  pull-requests: write
  repository-projects: write

concurrency:
  group: copilot-todo-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  implement:
    if: github.event.label.name == 'Todo'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v5
      - name: Update project status to In Progress
        uses: ./.github/actions/project-sync
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          project-number: ${{ vars.PROJECT_NUMBER }}
          project-owner: ${{ vars.PROJECT_OWNER }}
          item-type: issue
          item-url: ${{ github.event.issue.html_url }}
          status-field: In Progress
          automation-state-field: Implementing
      - name: Run Copilot Todo automation
        uses: ./.github/actions/copilot-exec
        env:
          REPO_NAME: "${{ github.repository }}"
          ISSUE_NUMBER: "${{ github.event.issue.number }}"
          ISSUE_TITLE: ${{ toJSON(github.event.issue.title) }}
          ISSUE_BODY: ${{ toJSON(github.event.issue.body || '') }}
          ISSUE_HTML_URL: ${{ toJSON(github.event.issue.html_url) }}
          ISSUE_AUTHOR: ${{ toJSON(github.event.issue.user.login) }}
        with:
          copilot-token: ${{ secrets.COPILOT_TOKEN }}
          prompt-path: .github/copilot/prompts/todo-issue
          output-path: >-
            reports/copilot/todo-issue-${{
            github.event.issue.number }}.log
      - name: Update project status after completion
        if: always()
        uses: ./.github/actions/project-sync
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          project-number: ${{ vars.PROJECT_NUMBER }}
          project-owner: ${{ vars.PROJECT_OWNER }}
          item-type: issue
          item-url: ${{ github.event.issue.html_url }}
          status-field: Under Review
          automation-state-field: PR Created
