---
name: Security Audit

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/guard-security-audit.yml'
  schedule:
    # Run daily at 00:00 UTC to catch new vulnerabilities
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: guard-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: |
          set +e
          npm audit --json > audit-results.json
          AUDIT_EXIT_CODE=$?
          set -e

          # Parse results
          VULNERABILITIES=$(cat audit-results.json | jq -r \
            '.metadata.vulnerabilities | to_entries |
             map("\(.key): \(.value)") | join(", ")')
          JQ_EXIT_CODE=$?
          if [ $JQ_EXIT_CODE -ne 0 ]; then
            echo "::error::Failed to parse audit results with jq"
            VULNERABILITIES="parsing_error"
            TOTAL="unknown"
          else
            TOTAL=$(cat audit-results.json | jq -r \
              '.metadata.vulnerabilities.total')
          fi

          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ "$TOTAL" = "unknown" ]; then
            echo "::error::Unable to determine vulnerability count " \
              "due to parsing error"
          elif [ "$TOTAL" -gt 0 ]; then
            echo "::warning::Found $TOTAL vulnerabilities: $VULNERABILITIES"
          else
            echo "::notice::No vulnerabilities found"
          fi

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30

      - name: Comment on PR
        if: >-
          github.event_name == 'pull_request' &&
          steps.audit.outputs.total != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const total = '${{ steps.audit.outputs.total }}';
            const vulnerabilities =
              '${{ steps.audit.outputs.vulnerabilities }}';
            const runUrl =
              'https://github.com/${{ github.repository }}/' +
              'actions/runs/${{ github.run_id }}';
            const body = `## ⚠️ Security Audit Failed

            Found **${total}** vulnerabilities in dependencies:

            ${vulnerabilities}

            Please review the [audit results](${runUrl}) and update
            dependencies to resolve security issues.

            Run \`npm audit\` locally for detailed information.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Send email notification for security vulnerabilities
        if: steps.audit.outputs.total != '0'
        uses: ./.github/actions/send-email-notification
        with:
          smtp-host: ${{ secrets.SMTP_HOST }}
          smtp-port: ${{ secrets.SMTP_PORT || '587' }}
          smtp-user: ${{ secrets.SMTP_USER }}
          smtp-password: ${{ secrets.SMTP_PASSWORD }}
          smtp-from: ${{ secrets.SMTP_FROM || secrets.SMTP_USER }}
          to: ${{ vars.EMAIL_NOTIFY_TO }}
          subject: >-
            [SECURITY] Vulnerabilities Detected -
            ${{ github.repository }}
          body: |
            Security Vulnerabilities Detected
            ==================================

            Total Vulnerabilities: ${{ steps.audit.outputs.total }}
            Details: ${{ steps.audit.outputs.vulnerabilities }}

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Run ID: ${{ github.run_id }}

            Please review and update dependencies to resolve
            security issues.

            View Details:
            https://github.com/${{ github.repository }}/actions/runs/${{
            github.run_id }}

            Run 'npm audit' locally for detailed information.

            This is an automated security alert from the Screeps
            dependency monitoring system.
          priority: "high"

      - name: Fail if vulnerabilities found
        if: steps.audit.outputs.total != '0'
        run: |
          VULN_COUNT="${{ steps.audit.outputs.total }}"
          echo "::error::Security audit found ${VULN_COUNT} \
          vulnerabilities"
          exit 1
